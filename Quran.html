<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>إذاعة القرآن الكريم</title>
<link href="https://db.onlinewebfonts.com/c/b86c0f3afb7b6eb1952be1d4c753140c?family=Al-Jazeera-Arabic-Regular" rel="stylesheet">

<style>
  :root{
    --bg:#0f1113; --muted:#9aa0a6; --accent:#282828; color-scheme: dark;
  }
  body{
    margin:0; 
    font-family:Al-Jazeera-Arabic-Regular,Segoe UI,Roboto,Arial; 
    background:var(--bg); 
    color:#e8eef2;
    user-select:none;
    direction: rtl;
    text-align: right;
  }
  .container{ 
    padding:12px; 
    max-width:720px; 
    margin:0 auto; 
  }
  .search{ 
    margin-bottom:10px; 
    text-align: right;
  }
  input[type="search"]{
    width:100%; 
    padding:12px 10px; 
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(255,255,255,0.02); 
    color:inherit; 
    font-size:16px;
    outline:none;
    text-align: right;
    direction: rtl;
  }
  input[type="search"]::placeholder{
    text-align: right;
    direction: rtl;
  }
  .group-title{
    margin:8px 0 6px 0; 
    padding:10px; 
    border-radius:10px;
    background:rgba(255,255,255,0.04); 
    cursor:pointer; 
    font-weight:600;
    transition:background .15s;
    text-align: right;
  }
  .group-title:active{ background:var(--accent); }
  ul.chlist{ 
    list-style:none; 
    padding:6px 6px 12px 6px; 
    margin:0; 
    display:none; 
  }
  li.chan{
    display:flex; 
    align-items:center; 
    margin:6px 0; 
    padding:8px;
    border-radius:8px; 
    transition:background .14s;
    justify-content: flex-start;
    gap: 12px;
  }
  li.chan:hover{ background:rgba(255,255,255,0.05); }
  li.chan:active{ background:var(--accent); }
  .logo{
    width:42px; 
    height:42px; 
    border-radius:50%; 
    overflow:hidden; 
    flex-shrink:0;
    display:flex; 
    align-items:center; 
    justify-content:center; 
    background:#333; 
    color:#ddd; 
    font-weight:700;
    order: 1;
  }
  .logo img{ 
    width:100%; 
    height:100%; 
    object-fit:cover; 
    display:block; 
  }
  .ch-title{ 
    font-size:15px; 
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis; 
    text-align: right;
    flex: 1;
    order: 2;
  }
  .results{ margin-top:8px; }
  .nores{ 
    color:var(--muted); 
    text-align:center; 
    padding:14px 0; 
  }
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: var(--muted);
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.1);
    border-left: 4px solid #e8eef2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .retry-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: #e8eef2;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
    transition: background .15s;
  }
  .retry-btn:hover {
    background: rgba(255,255,255,0.2);
  }
</style>
</head>
<body oncontextmenu="return false">
  <div class="container">
    <div class="search">
      <input id="searchInput" type="search" placeholder="بحث..." aria-label="بحث عن قناة">
    </div>
    <div id="loadingIndicator" class="loading" style="display:none">
      <div class="spinner"></div>
      <div>جاري تحميل القوائم...</div>
    </div>
    <div id="groupsRoot"></div>
    <div id="resultsRoot" class="results" style="display:none"></div>
  </div>

<script>
const SOURCE_RAW = "https://quran-mp3.pages.dev/data.txt";
const PROXIES = [
  "https://api.codetabs.com/v1/proxy?quest=",
  "https://corsproxy.io/?",
  "https://cors-anywhere.herokuapp.com/",
  "https://api.allorigins.win/raw?url="
];

let groupsData = {};
let allChannelsFlat = [];
let currentProxyIndex = 0;
const CACHE_KEY = 'radio_channels_cache';
const CACHE_EXPIRY = 30 * 60 * 1000; // 30 دقيقة
let searchTimeout = null;

function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

function showError(message, showRetry = true) {
  const root = document.getElementById('groupsRoot');
  root.innerHTML = `
    <div class="nores">
      <div>${message}</div>
      ${showRetry ? '<button class="retry-btn" onclick="init()">إعادة المحاولة</button>' : ''}
    </div>
  `;
}

// دالة لجلب البيانات مع إعادة المحاولة
async function fetchWithRetry(url, retries = 3, delay = 1000) {
  for (let i = 0; i < retries; i++) {
    try {
      const proxyUrl = PROXIES[currentProxyIndex] + encodeURIComponent(url);
      const response = await fetch(proxyUrl);
      
      if (response.ok) {
        return await response.text();
      }
    } catch (error) {
      console.error(`المحاولة ${i + 1} فشلت:`, error);
      
      // تجربة خادم وكيل مختلف في المحاولة التالية
      currentProxyIndex = (currentProxyIndex + 1) % PROXIES.length;
      
      if (i < retries - 1) {
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 1.5; // زيادة التأخير مع كل محاولة
      }
    }
  }
  
  throw new Error('فشل جميع محاولات الجلب');
}

// التحقق من صلاحية البيانات المخزنة
function isCacheValid(cacheData) {
  if (!cacheData || !cacheData.timestamp) return false;
  return (Date.now() - cacheData.timestamp) < CACHE_EXPIRY;
}

// تخزين البيانات محلياً
function saveToCache(data) {
  const cacheData = {
    data: data,
    timestamp: Date.now()
  };
  localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
}

// استرجاع البيانات من التخزين المحلي
function getFromCache() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      return JSON.parse(cached);
    }
  } catch (e) {
    console.error('خطأ في قراءة البيانات المخزنة:', e);
  }
  return null;
}

// مقارنة البيانات القديمة والجديدة وإضافة الجديد فقط
function mergeNewData(oldData, newData) {
  const oldGroups = parseM3UToObject(oldData);
  const newGroups = parseM3UToObject(newData);
  
  // دمج البيانات مع الحفاظ على البيانات القديمة وإضافة الجديدة فقط
  const mergedGroups = {...oldGroups};
  
  for (const groupName in newGroups) {
    if (!mergedGroups[groupName]) {
      // مجموعة جديدة تماماً
      mergedGroups[groupName] = newGroups[groupName];
    } else {
      // إضافة القنوات الجديدة فقط إلى المجموعة الموجودة
      const existingChannels = mergedGroups[groupName];
      const newChannels = newGroups[groupName];
      
      for (const newChannel of newChannels) {
        const exists = existingChannels.some(oldChannel => 
          oldChannel.name === newChannel.name && oldChannel.url === newChannel.url
        );
        
        if (!exists) {
          existingChannels.push(newChannel);
        }
      }
    }
  }
  
  return mergedGroups;
}

// تحويل بيانات M3U إلى كائن للمقارنة
function parseM3UToObject(txt) {
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let pending = null;
  const groups = {};

  for (let i=0;i<lines.length;i++){
    const line = lines[i];
    if (line.startsWith('#EXTINF')) {
      const nameMatch = line.match(/,(.*)$/);
      const groupMatch = line.match(/group-title="(.*?)"/i);
      const logoMatch  = line.match(/tvg-logo="(.*?)"/i) || line.match(/logo="(.*?)"/i);
      pending = {
        name: nameMatch ? nameMatch[1].trim() : '',
        group: groupMatch ? groupMatch[1].trim() : 'إذاعة عامة',
        logo: logoMatch ? logoMatch[1].trim() : ''
      };
      continue;
    }
    if (line.startsWith('#')) continue;
    if (pending){
      const ch = { 
        name: pending.name, 
        url: line, 
        logo: pending.logo, 
        group: pending.group 
      };
      if (!groups[ch.group]) groups[ch.group] = [];
      groups[ch.group].push(ch);
      pending = null;
    }
  }
  
  return groups;
}

// تحديث الواجهة مع البيانات المدمجة
function updateUIWithMergedData(mergedGroups) {
  groupsData = mergedGroups;
  
  // إعادة إنشاء القائمة المسطحة
  allChannelsFlat = [];
  for (const groupName in groupsData) {
    allChannelsFlat.push(...groupsData[groupName]);
  }
  
  renderGroups();
  setupSearch();
}

// تحديث البيانات في الخلفية
async function updateDataInBackground() {
  try {
    console.log('بدء التحديث في الخلفية...');
    const newData = await fetchWithRetry(SOURCE_RAW);
    
    // الحصول على البيانات المخزنة حالياً
    const cached = getFromCache();
    
    if (cached && cached.data) {
      // دمج البيانات القديمة مع الجديدة
      const mergedData = mergeNewData(cached.data, newData);
      
      // تحويل البيانات المدمجة إلى تنسيق M3U للتخزين
      const mergedM3U = convertGroupsToM3U(mergedData);
      saveToCache(mergedM3U);
      
      // تحديث الواجهة إذا كانت مفتوحة
      updateUIWithMergedData(mergedData);
    } else {
      // إذا لم تكن هناك بيانات مخزنة، حفظ البيانات الجديدة مباشرة
      saveToCache(newData);
      parseM3U(newData);
      renderGroups();
      setupSearch();
    }
    
    console.log('تم التحديث في الخلفية بنجاح');
  } catch (err) {
    console.error('فشل التحديث في الخلفية:', err);
  }
}

// تحويل كائن المجموعات إلى تنسيق M3U
function convertGroupsToM3U(groups) {
  let m3uContent = '#EXTM3U\n';
  
  for (const groupName in groups) {
    for (const channel of groups[groupName]) {
      m3uContent += `#EXTINF:-1 tvg-logo="${channel.logo}" group-title="${channel.group}",${channel.name}\n`;
      m3uContent += `${channel.url}\n`;
    }
  }
  
  return m3uContent;
}

async function init() {
  // عرض البيانات المخزنة فوراً إذا كانت موجودة
  const cached = getFromCache();
  
  if (cached && cached.data) {
    console.log('عرض البيانات المخزنة فوراً');
    parseM3U(cached.data);
    renderGroups();
    setupSearch();
    hideLoading();
  } else {
    showLoading();
  }
  
  // دائماً محاولة التحديث في الخلفية
  try {
    console.log('بدء التحديث...');
    const newData = await fetchWithRetry(SOURCE_RAW);
    
    if (cached && cached.data) {
      // دمج البيانات القديمة مع الجديدة
      const mergedData = mergeNewData(cached.data, newData);
      const mergedM3U = convertGroupsToM3U(mergedData);
      saveToCache(mergedM3U);
      updateUIWithMergedData(mergedData);
    } else {
      // إذا لم تكن هناك بيانات مخزنة، استخدام البيانات الجديدة مباشرة
      saveToCache(newData);
      parseM3U(newData);
      renderGroups();
      setupSearch();
    }
    
    console.log('تم التحديث بنجاح');
  } catch (err) {
    console.error('خطأ في التحديث:', err);
    
    // إذا فشل التحديث ولم تكن هناك بيانات مخزنة، عرض رسالة خطأ
    if (!cached || !cached.data) {
      showError('فشل تحميل القائمة. تأكد من اتصالك بالإنترنت.', true);
    }
  } finally {
    hideLoading();
  }
}

function cleanText(t){
  return (t||"")
    .replace(/[\u200B-\u200F\uFEFF]/g,"")
    .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"")
    .trim()
    .toLowerCase();
}

// دالة بحث متقدمة تعرض النتائج تلقائياً
function advancedSearch(query) {
  const results = [];
  const cleanQuery = cleanText(query);
  
  // تقسيم البحث إلى كلمات
  const words = cleanQuery.split(/\s+/).filter(word => word.length > 0);
  
  if (words.length === 0) return results;
  
  // البحث في جميع المجلدات والقنوات
  for (const groupName in groupsData) {
    const cleanGroupName = cleanText(groupName);
    
    // إذا كانت جميع كلمات البحث موجودة في اسم المجلد
    const allWordsInGroup = words.every(word => cleanGroupName.includes(word));
    
    // إذا كانت إحدى كلمات البحث تطابق اسم المجلد
    const someWordInGroup = words.some(word => cleanGroupName.includes(word));
    
    if (allWordsInGroup) {
      // إذا تطابقت جميع الكلمات مع اسم المجلد، عرض كل محتوياته
      results.push(...groupsData[groupName]);
    } else if (someWordInGroup) {
      // إذا تطابقت بعض الكلمات مع اسم المجلد، البحث في قنواته
      for (const channel of groupsData[groupName]) {
        const cleanChannelName = cleanText(channel.name);
        
        // البحث عن الكلمات المتبقية في اسم القناة
        const remainingWords = words.filter(word => !cleanGroupName.includes(word));
        
        if (remainingWords.length === 0) {
          // إذا لم تتبقى كلمات، عرض جميع قنوات المجلد
          results.push(channel);
        } else {
          // إذا تبقى كلمات، التحقق من تطابقها مع اسم القناة
          const allRemainingInChannel = remainingWords.every(word => 
            cleanChannelName.includes(word)
          );
          
          if (allRemainingInChannel) {
            results.push(channel);
          }
        }
      }
    } else {
      // إذا لم يتطابق أي كلمة مع اسم المجلد، البحث في قنواته فقط
      for (const channel of groupsData[groupName]) {
        const cleanChannelName = cleanText(channel.name);
        
        // التحقق إذا كانت جميع كلمات البحث موجودة في اسم القناة
        const allWordsInChannel = words.every(word => cleanChannelName.includes(word));
        
        if (allWordsInChannel) {
          results.push(channel);
        }
      }
    }
  }
  
  // إزالة التكرارات
  return [...new Set(results)];
}

// دالة لترتيب النتائج حسب مدى التطابق
function sortSearchResults(results, query) {
  const cleanQuery = cleanText(query);
  const words = cleanQuery.split(/\s+/);
  
  return results.sort((a, b) => {
    const aGroup = cleanText(a.group);
    const aName = cleanText(a.name);
    const bGroup = cleanText(b.group);
    const bName = cleanText(b.name);
    
    // حساب نقاط التطابق للعنصر أ
    let aScore = 0;
    let bScore = 0;
    
    // نقاط إضافية للتطابق الكامل مع المجلد
    words.forEach(word => {
      if (aGroup.includes(word)) aScore += 2;
      if (bGroup.includes(word)) bScore += 2;
      
      if (aName.includes(word)) aScore += 1;
      if (bName.includes(word)) bScore += 1;
    });
    
    return bScore - aScore;
  });
}

function parseM3U(txt){
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let pending = null;
  groupsData = {}; allChannelsFlat = [];

  for (let i=0;i<lines.length;i++){
    const line = lines[i];
    if (line.startsWith('#EXTINF')) {
      const nameMatch = line.match(/,(.*)$/);
      const groupMatch = line.match(/group-title="(.*?)"/i);
      const logoMatch  = line.match(/tvg-logo="(.*?)"/i) || line.match(/logo="(.*?)"/i);
      pending = {
        name: nameMatch ? nameMatch[1].trim() : '',
        group: groupMatch ? groupMatch[1].trim() : 'إذاعة عامة',
        logo: logoMatch ? logoMatch[1].trim() : ''
      };
      continue;
    }
    if (line.startsWith('#')) continue;
    if (pending){
      const ch = { 
        name: pending.name, 
        url: line, 
        logo: pending.logo, 
        group: pending.group 
      };
      if (!groupsData[ch.group]) groupsData[ch.group] = [];
      groupsData[ch.group].push(ch);
      allChannelsFlat.push(ch);
      pending = null;
    }
  }
}

function renderGroups(){8
  const root = document.getElementById('groupsRoot');
  root.innerHTML = '';
  
  if (Object.keys(groupsData).length === 0) {
    showError('لا توجد قنوات متاحة', true);
    return;
  }
  
  for (const g in groupsData){
    const title = document.createElement('div');
    title.className = 'group-title';
    title.textContent = g;
    const ul = document.createElement('ul');
    ul.className = 'chlist';
    // تمرير false لعدم عرض اسم المجموعة في القائمة الرئيسية
    groupsData[g].forEach(ch => ul.appendChild(makeChannelRow(ch, false)));
    title.addEventListener('click', ()=> {
      ul.style.display = ul.style.display === 'block' ? 'none' : 'block';
    });
    root.appendChild(title);
    root.appendChild(ul);
  }
}

function makeChannelRow(ch, showGroup = false) {
  const li = document.createElement('li');
  li.className = 'chan';
  const logo = document.createElement('div');
  logo.className = 'logo';
  if (ch.logo){
    const img = document.createElement('img'); 
    img.src = ch.logo; 
    img.alt = ch.name;
    img.onerror = function() {
      this.style.display = 'none';
      logo.textContent = ch.name.charAt(0).toUpperCase() || 'MP3';
    };
    logo.appendChild(img);
  } else { 
    logo.textContent = ch.name.charAt(0).toUpperCase() || 'MP3'; 
  }
  
  const t = document.createElement('div'); 
  t.className = 'ch-title'; 
  
  // إضافة اسم المجموعة إذا كان showGroup = true
  if (showGroup) {
    t.textContent = `${ch.group} | ${ch.name}`;
  } else {
    t.textContent = ch.name;
  }
  
  li.appendChild(logo); 
  li.appendChild(t);
  
  li.addEventListener('click', ()=> window.open(ch.url,'_blank'));
  return li;
}

function setupSearch(){
  const input = document.getElementById('searchInput');
  const groupsRoot = document.getElementById('groupsRoot');
  const resultsRoot = document.getElementById('resultsRoot');

  input.addEventListener('input', ()=>{
    // إلغاء البحث السابق إذا كان موجوداً
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // تأخير البحث لمدة 300 مللي ثانية بعد توقف المستخدم عن الكتابة
    searchTimeout = setTimeout(() => {
      const q = input.value.trim();
      if (!q){
        resultsRoot.style.display = 'none'; 
        groupsRoot.style.display = '';
        resultsRoot.innerHTML = '';
        return;
      }
      
      let matches = advancedSearch(q);
      
      // ترتيب النتائج حسب مدى التطابق
      matches = sortSearchResults(matches, q);
      
      resultsRoot.innerHTML = '';
      if (!matches.length){
        resultsRoot.innerHTML = '<div class="nores">لا توجد نتائج</div>';
      } else {
        const ul = document.createElement('ul');
        ul.className = 'chlist'; 
        ul.style.display = 'block';
        matches.forEach(ch => ul.appendChild(makeChannelRow(ch, true)));
        resultsRoot.appendChild(ul);
      }
      groupsRoot.style.display = 'none';
      resultsRoot.style.display = '';
    }, 300);
  });
}

// بدء التحميل عند فتح الصفحة
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>